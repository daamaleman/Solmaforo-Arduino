<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gráficos en Tiempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Montserrat", sans-serif;
      }
    </style>
  </head>
  <body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 to-yellow-100 transition-colors duration-500"
  >
    <!-- Navbar -->
    <nav
      class="fixed top-0 left-0 w-full bg-white/90 shadow-md z-50 flex items-center justify-between px-8 py-3 border-b border-gray-200"
    >
      <span class="text-xl font-bold tracking-tight text-yellow-600"
        >Solmáforo</span
      >
      <div>
        <a
          href="/"
          class="text-gray-700 hover:text-yellow-600 font-semibold transition-colors duration-200 mr-4"
          >Monitoreo</a
        >
        <a
          href="/graphs"
          class="text-yellow-600 font-semibold transition-colors duration-200"
          >Gráficos</a
        >
      </div>
    </nav>
    <div class="pt-20 w-full flex justify-center">
      <div
        class="bg-white/80 p-10 rounded-3xl shadow-2xl max-w-3xl w-full border border-gray-200 backdrop-blur-md"
      >
        <h1
          class="text-4xl font-extrabold text-gray-800 mb-8 text-center tracking-tight"
        >
          Gráficos en Tiempo Real
        </h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
          <div>
            <h2 class="text-lg font-semibold mb-2 text-center">Índice UV</h2>
            <canvas id="uvChart" height="220"></canvas>
          </div>
          <div>
            <h2 class="text-lg font-semibold mb-2 text-center">Voltaje</h2>
            <canvas id="voltChart" height="220"></canvas>
          </div>
        </div>
        <div
          id="error-msg"
          class="hidden text-center text-red-600 font-bold mt-4"
        >
          No se están recibiendo datos en tiempo real.
        </div>
      </div>
    </div>
    <script>
      const socket = io();
      const uvData = [];
      const voltData = [];
      const labels = [];
      const maxPoints = 30;
      let dataTimeout = null;

      // Gráfica de Índice UV
      const uvChart = new Chart(
        document.getElementById("uvChart").getContext("2d"),
        {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Índice UV",
                data: uvData,
                borderColor: "#facc15",
                backgroundColor: "rgba(250,204,21,0.2)",
                tension: 0.3,
                pointRadius: 2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, max: 15 },
            },
          },
        }
      );
      // Gráfica de Voltaje
      const voltChart = new Chart(
        document.getElementById("voltChart").getContext("2d"),
        {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Voltaje (V)",
                data: voltData,
                borderColor: "#38bdf8",
                backgroundColor: "rgba(56,189,248,0.2)",
                tension: 0.3,
                pointRadius: 2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, max: 5 },
            },
          },
        }
      );
      function showError(msg) {
        document.getElementById("error-msg").textContent = msg;
        document.getElementById("error-msg").classList.remove("hidden");
      }
      function hideError() {
        document.getElementById("error-msg").classList.add("hidden");
      }
      socket.on("uv_update", function (data) {
        hideError();
        console.log("Recibido:", data);
        const now = new Date();
        const timeLabel =
          now.getHours().toString().padStart(2, "0") +
          ":" +
          now.getMinutes().toString().padStart(2, "0") +
          ":" +
          now.getSeconds().toString().padStart(2, "0");
        labels.push(timeLabel);
        uvData.push(data.uv_index ?? 0);
        voltData.push(data.voltage ?? 0);
        if (labels.length > maxPoints) {
          labels.shift();
          uvData.shift();
          voltData.shift();
        }
        uvChart.update();
        voltChart.update();
        if (dataTimeout) clearTimeout(dataTimeout);
        dataTimeout = setTimeout(() => {
          showError("No se están recibiendo datos en tiempo real.");
        }, 5000);
      });
      // Si no llegan datos en 5 segundos, mostrar error
      setTimeout(() => {
        if (uvData.length === 0)
          showError("No se están recibiendo datos en tiempo real.");
      }, 5000);
    </script>
  </body>
</html>
